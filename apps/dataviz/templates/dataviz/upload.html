<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“Š è³‡æ–™è¦–è¦ºåŒ–å¹³å°</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light p-4">
<div class="container bg-white p-4 rounded shadow">
    <h2 class="mb-4">ğŸ“ˆ ä¸Šå‚³è³‡æ–™ä¸¦å»ºç«‹åœ–è¡¨</h2>

    <!-- ä¸Šå‚³è¡¨å–® -->
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
            <label class="form-label">é¸æ“‡ CSV æª”æ¡ˆï¼š</label>
            <input type="file" name="file" class="form-control" accept=".csv" required>
        </div>
        <button class="btn btn-primary" type="submit">ä¸Šå‚³</button>
    </form>

    {% if columns %}
    <hr>
    <h4>âœ… æˆåŠŸä¸Šå‚³ï¼é¸æ“‡æ¬„ä½èˆ‡æ¨£å¼ï¼š</h4>

    <form id="plotForm" class="mb-3">
        <div class="row mt-3">
            <div class="col-md-4">
                <label>X è»¸æ¬„ä½ï¼š</label>
                <select id="xAxis" class="form-select">
                    {% for col in columns %}
                        <option value="{{ col }}">{{ col }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label>Y è»¸æ¬„ä½ï¼š</label>
                <select id="yAxis" class="form-select">
                    {% for col in columns %}
                        <option value="{{ col }}">{{ col }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label>åœ–è¡¨é¡å‹ï¼š</label>
                <select id="chartType" class="form-select">
                    <option value="line">æŠ˜ç·šåœ–</option>
                    <option value="bar">é•·æ¢åœ–</option>
                    <option value="scatter">æ•£é»åœ–</option>
                </select>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-3">
                <label>é¡è‰²ï¼š</label>
                <input type="color" id="colorPicker" class="form-control form-control-color" value="#36A2EB">
            </div>
            <div class="col-md-3">
                <label>ç·šæ¢ç²—ç´°ï¼š</label>
                <input type="number" id="lineWidth" class="form-control" value="2" min="1" max="10">
            </div>
            <div class="col-md-3">
                <label>ç·šæ¢æ¨£å¼ï¼š</label>
                <select id="lineStyle" class="form-select">
                    <option value="solid">å¯¦ç·š</option>
                    <option value="dashed">è™›ç·š</option>
                    <option value="dotted">é»ç·š</option>
                </select>
            </div>
            <div class="col-md-3">
                <label>é»æ¨£å¼ï¼š</label>
                <select id="pointStyle" class="form-select">
                    <option value="circle">åœ“å½¢</option>
                    <option value="rect">æ–¹å½¢</option>
                    <option value="triangle">ä¸‰è§’å½¢</option>
                    <option value="cross">åå­—</option>
                </select>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label>åœ–ä¾‹åç¨±ï¼ˆå¯è‡ªè¨‚ï¼‰ï¼š</label>
                <input type="text" id="customLabel" class="form-control" placeholder="é è¨­ç‚º Y è»¸åç¨±">
            </div>
            <div class="col-md-3">
                <label>é¡¯ç¤ºåœ–ä¾‹ï¼š</label>
                <select id="showLegend" class="form-select">
                    <option value="true">æ˜¯</option>
                    <option value="false">å¦</option>
                </select>
            </div>
            <div class="col-md-3">
                <label>é¡¯ç¤ºåˆ»åº¦ï¼š</label>
                <select id="showTicks" class="form-select">
                    <option value="true">æ˜¯</option>
                    <option value="false">å¦</option>
                </select>
            </div>
        </div>
    </form>

    <div>
        <h5 class="mt-3">è³‡æ–™é è¦½ï¼š</h5>
        <div class="table-responsive" style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc;">
            {{ data_preview|safe }}
        </div>
    </div>

    <canvas id="chartCanvas" class="mt-4" height="120"></canvas>

    <div class="mt-4">
        <button id="drawChart" class="btn btn-success">ç¹ªè£½åœ–è¡¨ ğŸ¨</button>
    </div>
    {% endif %}
</div>

<script>
    const table = document.querySelector("table");
    let chart;

    document.getElementById("drawChart")?.addEventListener("click", function() {
        const xCol = document.getElementById("xAxis").value;
        const yCol = document.getElementById("yAxis").value;
        const type = document.getElementById("chartType").value;
        const color = document.getElementById("colorPicker").value;
        const lineWidth = parseInt(document.getElementById("lineWidth").value);
        const lineStyle = document.getElementById("lineStyle").value;
        const pointStyle = document.getElementById("pointStyle").value;
        const customLabel = document.getElementById("customLabel").value || `${yCol} vs ${xCol}`;
        const showLegend = document.getElementById("showLegend").value === "true";
        const showTicks = document.getElementById("showTicks").value === "true";

        const rows = Array.from(table.querySelectorAll("tr")).slice(1);
        const headers = Array.from(table.querySelectorAll("th")).map(h => h.textContent.trim());
        const xIndex = headers.indexOf(xCol);
        const yIndex = headers.indexOf(yCol);
        const xData = rows.map(row => row.children[xIndex].textContent);
        const yData = rows.map(row => parseFloat(row.children[yIndex].textContent));

        if (chart) chart.destroy();

        const ctx = document.getElementById("chartCanvas").getContext("2d");
        const borderDash =
            lineStyle === "dashed" ? [10, 5] :
            lineStyle === "dotted" ? [3, 3] : [];

        chart = new Chart(ctx, {
            type: type,
            data: {
                labels: xData,
                datasets: [{
                    label: customLabel,
                    data: yData,
                    backgroundColor: color + '80',
                    borderColor: color,
                    borderWidth: lineWidth,
                    borderDash: borderDash,
                    fill: false,
                    pointRadius: 5,
                    pointStyle: pointStyle,
                    showLine: type !== 'bar'
                }]
            },
            options: {
                plugins: {
                    legend: { display: showLegend }
                },
                scales: {
                    x: {
                        title: { display: true, text: xCol },
                        ticks: { display: showTicks }
                    },
                    y: {
                        title: { display: true, text: yCol },
                        ticks: { display: showTicks }
                    }
                }
            }
        });
    });
</script>
</body>
</html>
