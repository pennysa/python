<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è³‡æ–™è¦–è¦ºåŒ–å¹³å° ğŸ¨</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 30px; background-color: #fafafa; }
    .form-check-label { margin-right: 10px; }
    .info-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 15px 20px;
      margin-top: 15px;
    }
  </style>
</head>
<body>

  <h2>ğŸ“Š ä¸Šå‚³ CSV æª”æ¡ˆ</h2>
  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="data_file" accept=".csv" class="form-control mt-2" required>
    <button type="submit" class="btn btn-primary mt-3">ä¸Šå‚³</button>
  </form>

  {% if uploaded %}
  <hr>
  <div class="alert alert-success mt-3">
    âœ… {{ message }}
  </div>

  <!-- ğŸ“ æª”æ¡ˆè³‡è¨Šå¡ -->
  <div class="info-card">
    <div class="row">
      <div class="col-md-3"><strong>ğŸ“ æª”æ¡ˆåç¨±ï¼š</strong> {{ file_name }}</div>
      <div class="col-md-3"><strong>ğŸ•’ ä¸Šå‚³æ™‚é–“ï¼š</strong> {{ upload_time }}</div>
      <div class="col-md-3"><strong>âš™ï¸ ç·¨ç¢¼ï¼š</strong> {{ encoding }}</div>
      <div class="col-md-3"><strong>ğŸ“Š æª”æ¡ˆå¤§å°ï¼š</strong> {{ file_size }}</div>
    </div>
  </div>

  <!-- ç¼ºå¤±å€¼çµ±è¨ˆ -->
  <h5 class="mt-4">âš ï¸ ç¼ºå¤±å€¼çµ±è¨ˆï¼š</h5>
  <div class="table-responsive">
    {{ missing|safe }}
  </div>

  <!-- è‡ªå‹•æ‘˜è¦çµ±è¨ˆ -->
  <h5 class="mt-4">ğŸ“ˆ è‡ªå‹•æ‘˜è¦çµ±è¨ˆçµæœï¼š</h5>
  <div class="table-responsive">
    {{ summary|safe }}
  </div>

  <!-- ç¹ªåœ–è¨­å®š -->
  <hr>
  <h4 class="mt-4">ğŸ¨ è‡ªè¨‚åœ–è¡¨é¸é …ï¼š</h4>
  <div class="row g-3 mt-2">
    <div class="col-md-6">
      <label class="form-label">X è»¸æ¬„ä½ï¼š</label>
      <select id="x_col" class="form-select">
        {% for col in columns %}
          <option value="{{ col }}">{{ col }}</option>
        {% endfor %}
      </select>
      <input type="text" id="x_label" class="form-control mt-2" placeholder="å¯è‡ªè¨‚ X è»¸åç¨± (é è¨­ä½¿ç”¨æ¬„ä½å)">
    </div>

    <div class="col-md-6">
      <label class="form-label">Y è»¸æ¬„ä½ï¼ˆå¯å¤šé¸ï¼‰ï¼š</label><br>
      {% for col in columns %}
        <div class="form-check form-check-inline">
          <input class="form-check-input y-check" type="checkbox" value="{{ col }}" id="check_{{ col }}">
          <label class="form-check-label" for="check_{{ col }}">{{ col }}</label>
        </div>
      {% endfor %}
      <input type="text" id="y_label" class="form-control mt-2" placeholder="å¯è‡ªè¨‚ Y è»¸åç¨± (é è¨­ä½¿ç”¨æ¬„ä½å)">
    </div>
  </div>

  <div class="row g-3 mt-3">
    <div class="col-md-4">
      <label class="form-label">ç·šæ¢æ¨£å¼ï¼š</label>
      <select id="line_style" class="form-select">
        <option value="solid">å¯¦ç·š</option>
        <option value="dashed">è™›ç·š</option>
        <option value="dotted">é»ç·š</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">é»æ¨£å¼ï¼š</label>
      <select id="point_style" class="form-select">
        <option value="circle">åœ“é»</option>
        <option value="rect">æ–¹å½¢</option>
        <option value="triangle">ä¸‰è§’å½¢</option>
        <option value="cross">å‰å‰</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">é¡è‰²ï¼š</label>
      <input type="color" id="line_color" class="form-control form-control-color" value="#007bff">
    </div>
  </div>

  <div class="mt-4">
    <label class="form-label">åœ–ä¾‹åç¨±ï¼ˆå¯è‡ªè¨‚ï¼Œç•™ç™½ç”¨é è¨­ï¼‰ï¼š</label>
    <input type="text" id="legend_name" class="form-control" placeholder="ä¾‹ï¼šå¹³å‡æ™‚é–“ã€éŠ·å”®é‡ç­‰">
  </div>

  <div class="mt-4">
    <button id="draw-btn" class="btn btn-success">ğŸ¨ ç¹ªè£½åœ–è¡¨</button>
    <button id="download-btn" class="btn btn-outline-secondary ms-2">ğŸ’¾ ä¸‹è¼‰åœ–è¡¨ (PNG)</button>
  </div>

  <h5 class="mt-4">ğŸ“‹ è³‡æ–™é è¦½ï¼š</h5>
  <div class="table-responsive">
    {{ preview|safe }}
  </div>

  <canvas id="chart" class="mt-4"></canvas>
  {% endif %}

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const chartCanvas = document.getElementById('chart');
    let myChart = null;

    document.getElementById("draw-btn")?.addEventListener("click", (e) => {
      e.preventDefault();

      const xCol = document.getElementById("x_col").value;
      const yCols = [...document.querySelectorAll(".y-check:checked")].map(c => c.value);
      const xLabel = document.getElementById("x_label").value || xCol;
      const yLabel = document.getElementById("y_label").value || yCols.join(", ");
      const lineStyle = document.getElementById("line_style").value;
      const pointStyle = document.getElementById("point_style").value;
      const color = document.getElementById("line_color").value;
      const legendName = document.getElementById("legend_name").value || "åœ–è¡¨";

      if (yCols.length === 0) {
        alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ Y è»¸æ¬„ä½ï¼");
        return;
      }

      const labels = Array.from({length: 10}, (_, i) => i + 1);
      const data = labels.map(() => Math.floor(Math.random() * 10));

      if (myChart) myChart.destroy();

      myChart = new Chart(chartCanvas, {
        type: "line",
        data: {
          labels,
          datasets: yCols.map((col, i) => ({
            label: legendName + " - " + col,
            data: data.map(v => v + i * 2),
            borderColor: color,
            borderWidth: 2,
            borderDash: lineStyle === "dashed" ? [6, 6] : lineStyle === "dotted" ? [2, 3] : [],
            pointStyle: pointStyle,
            pointRadius: 4,
            backgroundColor: color,
            fill: false
          }))
        },
        options: {
          plugins: {
            legend: { position: "top" },
            tooltip: { enabled: true }
          },
          scales: {
            x: { title: { display: true, text: xLabel } },
            y: { title: { display: true, text: yLabel }, beginAtZero: true }
          }
        }
      });
    });

    // ç™½åº•ä¸‹è¼‰
    document.getElementById("download-btn")?.addEventListener("click", () => {
      const link = document.createElement('a');
      const whiteCanvas = document.createElement('canvas');
      const ctx = whiteCanvas.getContext('2d');
      whiteCanvas.width = chartCanvas.width;
      whiteCanvas.height = chartCanvas.height;
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, whiteCanvas.width, whiteCanvas.height);
      ctx.drawImage(chartCanvas, 0, 0);
      link.download = 'chart.png';
      link.href = whiteCanvas.toDataURL();
      link.click();
    });
  </script>

</body>
</html>

