{% extends 'core/base.html' %}
{% load static %}
{% block title %}è¡Œäº‹æ›†èˆ‡ä»»å‹™ç®¡ç†{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row gap-6">

  <!-- ğŸ“… å·¦é‚Šï¼šè¡Œäº‹æ›† -->
  <div class="flex-1 bg-white p-6 rounded-2xl shadow">
    <h2 class="text-xl font-bold text-indigo-700 mb-4">ğŸ“… è¡Œäº‹æ›†</h2>
    <div id="calendar"></div>
  </div>

  <!-- âœ… å³é‚Šï¼šTo-Do æ¸…å–® -->
  <div class="w-full md:w-80 bg-white p-6 rounded-2xl shadow flex flex-col">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-purple-700">ä»»å‹™æ¸…å–®</h2>
      <button id="add-btn"
        class="bg-purple-600 text-white px-3 py-1 rounded-lg hover:bg-purple-700 transition">
        â• æ–°å¢
      </button>
    </div>

    <!-- åˆ†é¡ç¯©é¸ -->
    <div class="mb-3">
      <select id="category-filter" class="w-full border rounded-lg px-2 py-1">
        <option>å…¨éƒ¨</option>
        <option>å­¸ç¿’</option>
        <option>å·¥ä½œ</option>
        <option>ç”Ÿæ´»</option>
      </select>
    </div>

    <!-- ä»»å‹™åˆ—è¡¨ -->
    <div id="task-list" class="space-y-2 max-h-[500px] overflow-y-auto flex-1"></div>
  </div>
</div>

<!-- ğŸªŸ ä»»å‹™ç·¨è¼¯å½ˆçª— -->
<div id="task-modal" class="fixed inset-0 hidden bg-black/40 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-2xl w-96 shadow-lg space-y-3 relative">
    <button id="close-modal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">âœ•</button>
    <h2 id="modal-title" class="text-lg font-semibold mb-2">ç·¨è¼¯ä»»å‹™</h2>

    <form id="task-form" class="space-y-3">
      <input type="hidden" id="task-id">
      <label class="block">
        <span class="text-gray-700 text-sm">æ¨™é¡Œ</span>
        <input type="text" id="task-title" class="w-full border rounded-lg p-2 mt-1" required>
      </label>

      <label class="block">
        <span class="text-gray-700 text-sm">åˆ†é¡</span>
        <select id="task-category" class="w-full border rounded-lg p-2 mt-1">
          <option>å­¸ç¿’</option>
          <option>å·¥ä½œ</option>
          <option>ç”Ÿæ´»</option>
        </select>
      </label>

      <label class="block">
        <span class="text-gray-700 text-sm">æ—¥æœŸ</span>
        <input type="date" id="task-start" class="w-full border rounded-lg p-2 mt-1">
      </label>

      <label class="block">
        <span class="text-gray-700 text-sm">æè¿°</span>
        <textarea id="task-desc" class="w-full border rounded-lg p-2 mt-1" rows="3"></textarea>
      </label>

      <div class="flex justify-between mt-4">
        <button type="button" id="done-btn" class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700">æ¨™ç¤ºå®Œæˆ</button>
        <div class="space-x-2">
          <button type="button" id="delete-btn" class="bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700">åˆªé™¤</button>
          <button type="submit" class="bg-indigo-600 text-white px-3 py-1 rounded-lg hover:bg-indigo-700">å„²å­˜</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const calendarEl = document.getElementById("calendar");
  const modal = document.getElementById("task-modal");
  const form = document.getElementById("task-form");
  const idInput = document.getElementById("task-id");
  const titleInput = document.getElementById("task-title");
  const categoryInput = document.getElementById("task-category");
  const dateInput = document.getElementById("task-start");
  const descInput = document.getElementById("task-desc");
  const modalTitle = document.getElementById("modal-title");
  const closeBtn = document.getElementById("close-modal");
  const deleteBtn = document.getElementById("delete-btn");
  const doneBtn = document.getElementById("done-btn");
  const listDiv = document.getElementById("task-list");
  const categoryFilter = document.getElementById("category-filter");
  const addBtn = document.getElementById("add-btn");

  // åˆå§‹åŒ–è¡Œäº‹æ›†
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: "dayGridMonth",
    locale: "zh-tw",
    editable: true,
    height: 650,
    eventSources: [{ url: "/timeline/tasks/", method: "GET" }],
    eventClick: function (info) {
      const id = info.event.id;
      fetch(`/timeline/task/${id}/`)
        .then(res => res.json())
        .then(task => {
          modal.classList.remove("hidden");
          modalTitle.textContent = "ç·¨è¼¯ä»»å‹™";
          idInput.value = task.id;
          titleInput.value = task.title;
          categoryInput.value = task.category;
          dateInput.value = task.start_date;
          descInput.value = task.description || "";
          doneBtn.textContent = task.is_done ? "âœ… å·²å®Œæˆ" : "æ¨™ç¤ºå®Œæˆ";
        });
    },
    eventDrop: function (info) {
      updateTask(info.event);
    },
  });
  calendar.render();

  // â• æ–°å¢ä»»å‹™
  addBtn.onclick = () => {
    form.reset();
    idInput.value = "";
    modalTitle.textContent = "æ–°å¢ä»»å‹™";
    doneBtn.textContent = "æ¨™ç¤ºå®Œæˆ";
    modal.classList.remove("hidden");
  };
  closeBtn.onclick = () => modal.classList.add("hidden");

  // å„²å­˜ä¿®æ”¹æˆ–æ–°å¢
  form.onsubmit = e => {
    e.preventDefault();
    const id = idInput.value;
    const payload = {
      title: titleInput.value,
      category: categoryInput.value,
      start: dateInput.value,
      description: descInput.value,
    };
    const url = id ? `/timeline/edit/${id}/` : "/timeline/add/";
    fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
      body: JSON.stringify(payload)
    }).then(() => {
      modal.classList.add("hidden");
      calendar.refetchEvents();
      loadTasks();
    });
  };

  // æ‹–æ›³æ›´æ–°æ—¥æœŸ
  function updateTask(event) {
    fetch(`/timeline/edit/${event.id}/`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
      body: JSON.stringify({
        title: event.title.split(" (")[0],
        category: event.title.match(/\((.*?)\)/)[1],
        start: event.startStr
      })
    }).then(() => {
      calendar.refetchEvents();
      loadTasks();
    });
  }

  // æ¨™ç¤ºå®Œæˆ
  doneBtn.onclick = () => {
    const id = idInput.value;
    fetch(`/timeline/toggle/${id}/`, { method: "POST", headers: { "X-CSRFToken": "{{ csrf_token }}" } })
      .then(() => { modal.classList.add("hidden"); calendar.refetchEvents(); loadTasks(); });
  };

  // åˆªé™¤ä»»å‹™
  deleteBtn.onclick = () => {
    const id = idInput.value;
    fetch(`/timeline/delete/${id}/`, { method: "POST", headers: { "X-CSRFToken": "{{ csrf_token }}" } })
      .then(() => { modal.classList.add("hidden"); calendar.refetchEvents(); loadTasks(); });
  };

  // å³å´ä»»å‹™æ¸…å–®
  function loadTasks(category = "å…¨éƒ¨") {
    fetch(`/timeline/tasks/?category=${category}`)
      .then(res => res.json())
      .then(tasks => {
        listDiv.innerHTML = "";
        tasks.forEach(t => {
          const div = document.createElement("div");
          div.className = "p-3 rounded-lg border-l-4 mb-2 cursor-pointer " +
            (t.title.includes("(å­¸ç¿’)") ? "border-purple-400 bg-purple-50"
             : t.title.includes("(å·¥ä½œ)") ? "border-blue-400 bg-blue-50"
             : "border-green-400 bg-green-50");
          div.innerHTML =
            `<p class="font-semibold">${t.title}</p>
             <p class="text-sm text-gray-600">${t.start}</p>`;
          div.onclick = () => {
            fetch(`/timeline/task/${t.id}/`)
              .then(res => res.json())
              .then(task => {
                modal.classList.remove("hidden");
                modalTitle.textContent = "ç·¨è¼¯ä»»å‹™";
                idInput.value = task.id;
                titleInput.value = task.title;
                categoryInput.value = task.category;
                dateInput.value = task.start_date;
                descInput.value = task.description || "";
              });
          };
          listDiv.appendChild(div);
        });
      });
  }

  categoryFilter.onchange = e => loadTasks(e.target.value);
  loadTasks();
});
</script>
{% endblock %}
